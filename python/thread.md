# python中的多线程和多进程

## 基本概念

### 进程和线程
进程：操作系统**分配资源**的最小单位。
线程：操作系统**调度**的最小单位。
一个进程中可以包含多个线程，而多个线程共享一个进程里面的内存空间。

### CPU密集型和IO密集型

CPU密集型（CPU-bound）：CPU密集型也叫计算密集型。其是指在系统运行中，大部分时间都在进行计算，逻辑判断等操作，CPU的占用率一直很高，而I/O在很短的时间就可以完成。其主要特点在于，运行需要**大量的计算**，消耗cpu资源，如：压缩，解压缩，加密解密，对视频进行高清解码等等。这种计算密集型任务虽然也可以用多任务完成，但是任务越多，花在任务切换的时间就越多，CPU执行任务的效率就越低，所以，要最高效地利用CPU，计算密集型任务同时进行的数量应当等于CPU的核心数。

IO密集型（I/O-bound）：IO密集型是指在系统运行中，大部分时间都在等待I/O (硬盘/内存) 的读/写操作，而CPU的占用率一直很低。

### 多进程和多线程
多进程：利用多核cpu并行计算，**并行**的执行任务。即：同一时间下，多个任务同时执行。

多线程：多线程只能**并发**执行，不能利用多个cpu。即：同一个时间下，多个任务间隔执行。

### 全局解释器锁GIL（Global Interpreter Lock）
每个CPU在同一时间只能执行一个线程，保证数据的安全性。

### python中如何使用多线程和多进程
当我们遇到一些计算量很大的任务时，由于其是*计算密集型*，主要消耗cpu。那么可以考虑使用`多进程 multiprocess`。相比原来的一个cpu计算，多个cpu同时计算会提升更多。

由于python中`GIL`的存在，一个进程中仅当有一个线程能够执行。

当遇到频繁的文件读写操作时，由于其主要是进行IO操作，而cpu几乎是处于等待状态。所以即使使用多进程，利用多核cpu的特性建立几个任务同时执行，耗费的时间也不不会减少，**反而会增加**。因为当多核的情况下，当第一个cpu上的线程执行完后，会释放GIL，而其他几个cpu上的线程进行竞争。但如果马上又被第一个cpu上的线程拿到GIL，那么其他cpu上的线程就会被唤醒后一直等待切换时间，又进入待调度状态，造成**线程颠簸(thrashing)**，导致效率更低。而如果是多线程的情况，也就是单核下多线程，每次释放GIL，当一个线程将被切换时，唤醒的另一个线程都能获取到GIL锁，所以能够无缝执行，不会造成cpu的浪费。

所以，我们可以简单的进行总结：

**多进程更适用于计算密集型任务。多线程更适用于IO密集型任务。在python中，由于GIL的存在，我们可以简单的理解为其多线程就是并行的单线程**



参考：
https://zhuanlan.zhihu.com/p/62766037

https://zhuanlan.zhihu.com/p/46368084

https://zhuanlan.zhihu.com/p/20953544

